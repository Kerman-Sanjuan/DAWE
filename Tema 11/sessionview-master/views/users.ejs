<html>
    <head>
        <title>Tema 11</title>
        <script
            src="https://code.jquery.com/jquery-3.3.1.js"
            integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
            crossorigin="anonymous"
        ></script>
        <script>
            var id;

            $(document).ready(function () {
                $(".deleteUser").on("click", deleteUser);
            });

            function deleteUser() {
                //alert('Borrar!');
                alert($(this).data("id"));
            }

            function deleteUser() {
                var confirmation = confirm("Are You Sure?");
                if (confirmation) {
                    $.ajax({
                        type: "DELETE",
                        url: "/users/delete/" + $(this).data("id"),
                    }).done(function (response) {
                        window.location.replace("/users");
                    });
                } else {
                    return false;
                }
            }

            $(document).ready(function () {
                $(".editUser").on("click", editUser);
            });

            function editUser() {
                // Necesito que al clickar en el botón editar algo me devuelva la información del usuario que quiero editar.
                // Lo haré mediante API Fetch, en la dirección /users/obtenerInfoUsuario/:id
                id = $(this).data("id");
                fetch("/users/obtenerInfoUsuario/" + id)
                    .then((response) => {
                        return response.json();
                    })
                    .then((response) => {
                        //nos ha devuleto un array de JSON, en el que en la posicion 0 están nuestros datos
                        var datos = response[0];
                        document.getElementById("first_name").value =
                            datos.first_name;
                        document.getElementById("last_name").value =
                            datos.last_name;
                        document.getElementById("email").value = datos.email;
                    });

                // Ahora cambiamos el texto del botón a EDITAR
                document.getElementById("boton").value = "EDITAR";
            }

            // Necesitamos una función que diferencie cuando se pulsa el botón en modo EDITAR o el modo original

            function pulsarBoton() {
                // Miramos si está en modo original de añadir. Si es así, actua como dice el formulario:
                // <form method="POST" action="/users/add" id="form">

                if (document.getElementById("boton").value == "Enviar") {
                    document.getElementById("form").submit();
                } else {
                    //Está en modo editar

                    //Creamos un JSON con los datos nuevos
                    var usuarioEditado = {
                        first_name: document.getElementById("first_name").value,
                        last_name: document.getElementById("last_name").value,
                        email: document.getElementById("email").value,
                    };

                    // https://developer.mozilla.org/es/docs/Web/API/Fetch_API/Using_Fetch#proporcionando_tu_propio_objeto_request
                    //https://developer.mozilla.org/es/docs/Web/API/Fetch_API/Using_Fetch#suministrando_opciones_de_petici%C3%B3n
                    //https://stackoverflow.com/questions/29775797/fetch-post-json-data
                    fetch("/users/actualizarInfoUsuario/" + id, {
                        method: "POST",
                        headers: {
                            Accept: "application/json, text/plain, */*",
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(usuarioEditado),
                    }).then((response) => {
                        window.location.replace("/users");
                    });
                }
            }
        </script>
    </head>
    <body>
        <h1>Hola <%=usuario %></h1>
        <h1>Insertar cliente</h1>
        <ul>
            <form method="POST" action="/users/add" id="form">
                <label>Nombre</label>
                <input type="text" name="first_name" id="first_name" />
                <br />
                <label>Apellido</label>
                <input type="text" name="last_name" id="last_name" />
                <br />
                <label>Email</label>
                <input type="text" name="email" id="email" />
                <br />
                <!-- Quiero diferenciar entre valores del botón, así que mejor usar un botón -->
                <!-- <input type="submit" Value="Enviar" name="submit" id="boton" onclick="return pulsarBoton();"> -->
                <input
                    type="button"
                    Value="Enviar"
                    id="boton"
                    name="boton"
                    onclick="return pulsarBoton()"
                />
            </form>
        </ul>
        <h1><%=title %></h1>
        <ul>
            <% users.forEach(function(user) { %>
            <li>
                <%=user.first_name %> <%= user.last_name%> -
                <a href="#" class="deleteUser" data-id="<%= user._id %>"
                    >Delete</a
                >
                -
                <a href="#" class="editUser" data-id="<%= user._id %>">Edit</a>
            </li>
            <% }) %>
        </ul>
        <a href="/logout" class="logout">Logout</a>
    </body>
</html>
